# GitLab CI/CD Pipeline for zRAM/SWAP Manager (Magisk Module)
# Optimized for Android Magisk module build and deployment

image: alpine:latest

stages:
  - validate
  - lint
  - test
  - build
  - package
  - deploy

variables:
  GIT_DEPTH: 10
  MODULE_ID: zram_config
  ANDROID_SDK_VERSION: "33"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VALIDATE STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

validate:structure:
  stage: validate
  before_script:
    - apk add --no-cache bash make
  script:
    - echo "â†’ Validating module structure..."
    - test -f module.prop || exit 1
    - test -f install.sh || exit 1
    - test -f META-INF/com/google/android/update-binary || exit 1
    - test -f common/service.sh || exit 1
    - echo "âœ“ Module structure valid"
  tags:
    - docker

validate:syntax:
  stage: validate
  before_script:
    - apk add --no-cache bash
  script:
    - echo "â†’ Checking shell syntax..."
    - bash -n install.sh
    - bash -n uninstall.sh
    - bash -n META-INF/com/google/android/update-binary
    - find common -name "*.sh" -exec bash -n {} \;
    - echo "âœ“ Syntax check passed"
  tags:
    - docker

validate:module_prop:
  stage: validate
  before_script:
    - apk add --no-cache bash grep
  script:
    - echo "â†’ Validating module.prop..."
    - grep -q "^id=" module.prop || exit 1
    - grep -q "^name=" module.prop || exit 1
    - grep -q "^version=" module.prop || exit 1
    - grep -q "^versionCode=" module.prop || exit 1
    - grep -q "^author=" module.prop || exit 1
    - echo "âœ“ module.prop is valid"
  artifacts:
    reports:
      dotenv: build.env
  tags:
    - docker

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LINT STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

lint:shellcheck:
  stage: lint
  image: koalaman/shellcheck-alpine:stable
  before_script:
    - apk add --no-cache bash make
  script:
    - echo "â†’ Running shellcheck..."
    - make check
    - echo "âœ“ Shellcheck passed"
  allow_failure: false
  tags:
    - docker

lint:format:
  stage: lint
  image: mvdan/shfmt:latest-alpine
  before_script:
    - apk add --no-cache make
  script:
    - echo "â†’ Checking code formatting..."
    - shfmt -d -i 4 -ci . || true
    - echo "âœ“ Format check complete"
  allow_failure: true
  tags:
    - docker

lint:security:
  stage: lint
  before_script:
    - apk add --no-cache bash grep
  script:
    - echo "â†’ Running security checks..."
    - |
      ISSUES=0
      echo "Checking for dangerous patterns..."
      
      # Check for dangerous rm commands
      if grep -rn "rm -rf /" . --include="*.sh" --exclude-dir=build; then
        echo "âš  Dangerous rm -rf / found"
        ISSUES=$((ISSUES+1))
      fi
      
      # Check for eval usage
      if grep -rn "eval " . --include="*.sh" --exclude-dir=build; then
        echo "âš  eval usage detected"
        ISSUES=$((ISSUES+1))
      fi
      
      # Check for hardcoded credentials
      if grep -rni "password\|apikey\|secret" . --include="*.sh" --exclude-dir=build; then
        echo "âš  Potential hardcoded credentials"
        ISSUES=$((ISSUES+1))
      fi
      
      echo "Security scan complete with $ISSUES potential issues"
  allow_failure: true
  tags:
    - docker

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEST STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test:module:
  stage: test
  before_script:
    - apk add --no-cache bash make grep
  script:
    - echo "â†’ Running module tests..."
    - make test
    - echo "âœ“ Module tests passed"
  artifacts:
    reports:
      junit: test-results.xml
  tags:
    - docker

test:service_script:
  stage: test
  before_script:
    - apk add --no-cache bash
  script:
    - echo "â†’ Testing service script..."
    - bash -n common/service.sh
    - |
      # Check for required functions
      grep -q "enable_swap" common/service.sh || exit 1
      grep -q "disable_swap" common/service.sh || exit 1
    - echo "âœ“ Service script valid"
  tags:
    - docker

test:unity_scripts:
  stage: test
  before_script:
    - apk add --no-cache bash
  script:
    - echo "â†’ Testing Unity scripts..."
    - bash -n common/unity_install.sh
    - bash -n common/unity_uninstall.sh || true
    - bash -n common/unity_upgrade.sh || true
    - bash -n common/unityfiles/util_functions.sh
    - echo "âœ“ Unity scripts valid"
  tags:
    - docker

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BUILD STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

build:standard:
  stage: build
  needs: ["validate:module_prop"]
  before_script:
    - apk add --no-cache bash make zip
  script:
    - echo "â†’ Building standard module..."
    - make build
    - ls -lh *.zip
    - echo "âœ“ Build complete"
  artifacts:
    name: "${MODULE_ID}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - "*.zip"
    expire_in: 30 days
  tags:
    - docker

build:variants:
  stage: build
  needs: ["validate:module_prop"]
  before_script:
    - apk add --no-cache bash make zip
  script:
    - echo "â†’ Building module variants..."
    - make release
    - ls -lh release/
    - echo "âœ“ All variants built"
  artifacts:
    name: "${MODULE_ID}-release-${CI_COMMIT_SHORT_SHA}"
    paths:
      - release/
    expire_in: 30 days
  only:
    - tags
    - main
  tags:
    - docker

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PACKAGE STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package:checksums:
  stage: package
  needs: ["build:standard"]
  before_script:
    - apk add --no-cache bash coreutils
  script:
    - echo "â†’ Creating checksums..."
    - sha256sum *.zip > checksums.sha256
    - md5sum *.zip > checksums.md5
    - cat checksums.sha256
    - echo "âœ“ Checksums created"
  artifacts:
    paths:
      - checksums.*
    expire_in: 30 days
  tags:
    - docker

package:metadata:
  stage: package
  needs: ["build:standard"]
  before_script:
    - apk add --no-cache bash jq
  script:
    - echo "â†’ Generating metadata..."
    - |
      cat > metadata.json <<EOF
      {
        "id": "$(grep -oP '(?<=id=).*' module.prop)",
        "name": "$(grep -oP '(?<=name=).*' module.prop)",
        "version": "$(grep -oP '(?<=version=).*' module.prop)",
        "versionCode": $(grep -oP '(?<=versionCode=).*' module.prop),
        "author": "$(grep -oP '(?<=author=).*' module.prop)",
        "description": "$(grep -oP '(?<=description=).*' module.prop)",
        "commit": "${CI_COMMIT_SHORT_SHA}",
        "branch": "${CI_COMMIT_REF_NAME}",
        "pipeline": "${CI_PIPELINE_ID}"
      }
      EOF
    - cat metadata.json
    - echo "âœ“ Metadata generated"
  artifacts:
    paths:
      - metadata.json
    expire_in: 30 days
  tags:
    - docker

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPLOY STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deploy:pages:
  stage: deploy
  needs: ["build:standard", "package:metadata"]
  before_script:
    - apk add --no-cache bash
  script:
    - echo "â†’ Generating documentation..."
    - mkdir -p public
    - |
      cat > public/index.html <<'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>zRAM/SWAP Manager</title>
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                 min-height: 100vh; padding: 20px; }
          .container { max-width: 900px; margin: 0 auto; 
                      background: white; border-radius: 15px; 
                      padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
          h1 { color: #333; margin-bottom: 10px; font-size: 2.5em; }
          .version { color: #666; font-size: 1.2em; margin-bottom: 30px; }
          .description { color: #555; line-height: 1.8; margin-bottom: 30px; font-size: 1.1em; }
          .download { background: #667eea; color: white; padding: 15px 40px; 
                     border: none; border-radius: 8px; font-size: 1.1em; 
                     cursor: pointer; text-decoration: none; display: inline-block;
                     transition: all 0.3s; }
          .download:hover { background: #5568d3; transform: translateY(-2px);
                           box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
          .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                     gap: 20px; margin: 30px 0; }
          .feature { padding: 20px; background: #f8f9fa; border-radius: 10px;
                    border-left: 4px solid #667eea; }
          .feature h3 { color: #667eea; margin-bottom: 10px; }
          .feature p { color: #666; line-height: 1.6; }
          .stats { display: flex; justify-content: space-around; margin: 30px 0;
                  padding: 20px; background: #f8f9fa; border-radius: 10px; }
          .stat { text-align: center; }
          .stat-value { font-size: 2em; color: #667eea; font-weight: bold; }
          .stat-label { color: #666; margin-top: 5px; }
          code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px;
                font-family: 'Courier New', monospace; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>ğŸš€ zRAM/SWAP Manager</h1>
          <div class="version">Version 1.3</div>
          <p class="description">
            A powerful Magisk module that enables or disables zRAM on Android devices. 
            Using zRAM can significantly increase performance by avoiding disk paging and 
            instead using a compressed block device in the physical RAM.
          </p>
          
          <a href="#" class="download">â¬‡ Download Latest Version</a>
          
          <div class="stats">
            <div class="stat">
              <div class="stat-value">v1.3</div>
              <div class="stat-label">Latest Version</div>
            </div>
            <div class="stat">
              <div class="stat-value">130</div>
              <div class="stat-label">Version Code</div>
            </div>
            <div class="stat">
              <div class="stat-value">Magisk</div>
              <div class="stat-label">Platform</div>
            </div>
          </div>
          
          <div class="features">
            <div class="feature">
              <h3>âš¡ Performance Boost</h3>
              <p>Compress RAM data to free up memory and improve multitasking performance</p>
            </div>
            <div class="feature">
              <h3>ğŸ›ï¸ Easy Control</h3>
              <p>Enable or disable zRAM with volume keys during installation</p>
            </div>
            <div class="feature">
              <h3>ğŸ”§ Auto Configuration</h3>
              <p>Automatically calculates optimal zRAM size based on your device's RAM</p>
            </div>
            <div class="feature">
              <h3>ğŸ“± Wide Support</h3>
              <p>Compatible with Magisk 15.3+ on most Android devices</p>
            </div>
          </div>
          
          <h2>Installation</h2>
          <ol style="line-height: 2; color: #555; margin: 20px 0;">
            <li>Download the module ZIP file</li>
            <li>Open Magisk Manager</li>
            <li>Go to Modules â†’ Install from storage</li>
            <li>Select the downloaded ZIP</li>
            <li>Use Volume Keys to enable/disable zRAM</li>
            <li>Reboot your device</li>
          </ol>
          
          <h2>How it works</h2>
          <p style="color: #555; line-height: 1.8; margin: 20px 0;">
            The module uses advanced algorithms (LZ4/ZSTD) to compress memory in real-time. 
            It automatically calculates the optimal zRAM size based on your total RAM:
          </p>
          <ul style="color: #555; line-height: 2; margin: 20px 0 20px 40px;">
            <li><code>&gt; 3GB RAM</code>: 2048MB zRAM</li>
            <li><code>&gt; 2GB RAM</code>: 1792MB zRAM</li>
            <li><code>&gt; 1GB RAM</code>: 1024MB zRAM</li>
            <li><code>&lt; 1GB RAM</code>: 768MB zRAM</li>
          </ul>
        </div>
      </body>
      </html>
      EOF
    - cp README.md public/ 2>/dev/null || true
    - cp metadata.json public/ 2>/dev/null || true
    - echo "âœ“ Documentation generated"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main
  tags:
    - docker

deploy:release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build:variants
      artifacts: true
    - job: package:metadata
      artifacts: true
  script:
    - echo "â†’ Creating GitLab release..."
  release:
    tag_name: '$CI_COMMIT_TAG'
    name: 'zRAM Manager $CI_COMMIT_TAG'
    description: |
      ## zRAM/SWAP Manager $CI_COMMIT_TAG
      
      ### What's New
      - Bug fixes and improvements
      - Unity template updated
      
      ### Installation
      1. Download the ZIP file below
      2. Flash via Magisk Manager or TWRP
      3. Use Volume Keys to enable/disable zRAM
      4. Reboot
      
      ### Features
      - âš¡ Automatic zRAM size calculation
      - ğŸ›ï¸ Volume key selector during install
      - ğŸ”§ LZ4/ZSTD compression support
      - ğŸ“± Compatible with most Android devices
      
      ### Downloads
      - **Standard**: For normal installation
      - **Enable**: Pre-configured to enable zRAM
      - **Disable**: Pre-configured to disable zRAM
    assets:
      links:
        - name: 'Standard Version'
          url: '${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:variants'
          link_type: package
  only:
    - tags
  tags:
    - docker

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILITY JOBS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

update_readme:
  stage: deploy
  before_script:
    - apk add --no-cache bash git
  script:
    - echo "â†’ Updating README badges..."
    - |
      # Update pipeline badge in README
      sed -i "s|badges/main/pipeline.svg|badges/${CI_COMMIT_REF_NAME}/pipeline.svg|g" README.md || true
    - echo "âœ“ README updated"
  only:
    - main
  when: manual
  tags:
    - docker