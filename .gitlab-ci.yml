# GitLab CI/CD Pipeline for zram-manager
# Optimized for shell script testing and deployment

# Define pipeline stages
stages:
  - lint
  - test
  - build
  - package
  - deploy

# Global variables
variables:
  GIT_DEPTH: 10
  SHELLCHECK_VERSION: "stable"
  SHFMT_VERSION: "v3.7.0"

# Cache dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/

# Template for shell script jobs
.shell_job_template:
  image: koalaman/shellcheck-alpine:stable
  before_script:
    - apk add --no-cache bash make git

# =====================
# LINT STAGE
# =====================

shellcheck:
  stage: lint
  extends: .shell_job_template
  script:
    - echo "Running shellcheck..."
    - make check
  allow_failure: false
  tags:
    - docker

shell_format_check:
  stage: lint
  image: mvdan/shfmt:${SHFMT_VERSION}-alpine
  before_script:
    - apk add --no-cache make
  script:
    - echo "Checking shell script formatting..."
    - shfmt -d -i 4 -ci .
  allow_failure: true
  tags:
    - docker

# =====================
# TEST STAGE
# =====================

unit_tests:
  stage: test
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq bash make shellcheck
  script:
    - echo "Running unit tests..."
    - make test
  coverage: '/Lines:\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      junit: test-results.xml
    paths:
      - test-results.xml
    expire_in: 1 week
  tags:
    - docker

integration_tests:
  stage: test
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq bash make util-linux
  script:
    - echo "Running integration tests..."
    - bash tests/integration_tests.sh || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop
  tags:
    - docker

# =====================
# BUILD STAGE
# =====================

build:
  stage: build
  image: alpine:latest
  before_script:
    - apk add --no-cache bash make tar gzip
  script:
    - echo "Building project..."
    - make check
    - echo "Build successful!"
  artifacts:
    paths:
      - zram-manager
    expire_in: 1 day
  tags:
    - docker

# =====================
# PACKAGE STAGE
# =====================

create_package:
  stage: package
  image: alpine:latest
  before_script:
    - apk add --no-cache bash make tar gzip
  script:
    - echo "Creating distribution package..."
    - make package
    - ls -lh dist/
  artifacts:
    name: "zram-manager-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/*.tar.gz
    expire_in: 30 days
  only:
    - tags
    - main
  tags:
    - docker

debian_package:
  stage: package
  image: debian:bullseye
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq build-essential devscripts debhelper
  script:
    - echo "Building Debian package..."
    - dpkg-buildpackage -us -uc -b || echo "Debian packaging not configured"
  artifacts:
    paths:
      - ../*.deb
    expire_in: 30 days
  only:
    - tags
  allow_failure: true
  tags:
    - docker

# =====================
# DEPLOY STAGE
# =====================

# Deploy to GitLab releases
release_job:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating GitLab release..."
  release:
    tag_name: '$CI_COMMIT_TAG'
    description: './CHANGELOG.md'
    assets:
      links:
        - name: 'zram-manager package'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/download'
  only:
    - tags
  tags:
    - docker

# Deploy documentation
pages:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache bash make
  script:
    - mkdir -p public
    - echo "<html><head><title>zram-manager</title></head><body><h1>zram-manager Documentation</h1></body></html>" > public/index.html
    - cp README* public/ 2>/dev/null || true
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main
  tags:
    - docker

# =====================
# SECURITY SCANNING
# =====================

security_scan:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache bash git
  script:
    - echo "Running security scan..."
    - grep -r "eval\|exec\|system" . || true
    - echo "Security scan complete"
  allow_failure: true
  tags:
    - docker

# =====================
# MANUAL JOBS
# =====================

manual_deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash
  script:
    - echo "Deploying to production server..."
    - echo "Add your deployment commands here"
  when: manual
  only:
    - main
  environment:
    name: production
    url: https://example.com
  tags:
    - docker